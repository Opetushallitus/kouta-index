sudo: required
language: clojure
jdk:
  - openjdk11
services:
  - docker

cache:
  directories:
  - $HOME/.m2

env:
  global:
    # AWS_ACCESS_KEY_ID
    - secure: "Ll/R9jT2hH0qlh/ds55RadSdn/mOb7ibBeMFbQx6vnD2eroISTq2loEenk2HL+blwGcR68Zd1fSNQMrTS6lVqoi9lZcPjGKFxpiBJEqoJGBXW6xqpNAGPq9RYE7WmI/Ve8tuPUp8N7bNoK96WAwp2JQ/9s/CxDz3nbfuZTwsseEU+DdFYHbvatcTvHjQQdH9Hf/DjsA1gan5JhBDbArc/FhfvpKjUB+EEKFnGzj01m9O478UK6kwRTvdlMUp0nvacFErvEy28WUXQXz1Xo9/Ly/fqU/WsxTbUpDXyYD7LnPD+3wCLfvaarIqh7R+Bs1cIHZlwIpw8m55ty6zELbLarUawiai6Ag6s1TjGRRXGuAGtLCpku8AHRx5HGaIjdcdUHoLhkH6L6PIjQGnE7eXzh3rkSMHez6TWWAQXYw3qQml/JVm5Zc10tUAVVS2mA0/IEvoJlKDU1o+ojUmIR6WaC+iLJfkjDcvD7nH8CMTSZRy7kJMIwIFJYyJtO+NFnYPUDrfHW/Q5+dF9s4RPLcfBHQDLBgK3f4xvxTB4w6alRP3/B51FJPR6FsMoLto3ev9M/t6Qh+/BuiuwXqaxL8mlwbDvAYD7WJYm+Hiogey8EyM4w6UJEQwU2OwcMUDKQ26exwZXv03cEEwScJCj0V30bYKov9+4uvvAlfm/3E5puw="
    # AWS_SECRET_ACCESS_KEY
    - secure: "HiP3/uRdRJiVe2U7QZfYgK61Vy+jS/uabZ7CRsfnA8u2psSM+EKm4yqX66jLLj/arYxNeaZ5om9YGXRV39YFsO5Bf0ZzQqrkCGf7ZpL02EVoFNM4QbZrt5sWbNDLxY7eEaG+aFrO/PeCjdh01jlIlBeFRry+443Vf4EbbBKvfgRGTIF9R9ype3fQ6VAGPRRQW9XSIx99WmUWU7xpZQ27S4MmpbRNWrNJ9Twn1Z6/sDHjJ5+qVAglTZU8WJxWKyZT2KF0DgNC6qTp4VNLYiNjVesS13bvsipjVgDKDmzZnsdwdHIQfiH3l8M4WM3Mx1ZGXpgRr3VEJhy77OoESyouQAR/Td1I9uEViFSAPp8CWZBE7+afGU5d9gQw8PrntrpwveEHdGwLTyPK09mwYTQ6FHcPOdrPHaVhKhf+UErX2TMdTSsohXbqMQm6o2MeAeVXt5Yl8IPuqLpUbBsunSoxisjDjq1FawDPZK1R8JfXWlIGEff1Uo6HiM0Aa1S90YqQkHoDBp0RvCAxoOIYaKO7+lOwftR6mK4J4hXArbfXQ44McB8NZGRrh/IHr5Z6jV3eq6L4JyYSK+Uw4IpLZ0fNHwns5yTGpRP2WkV5a/+jHevMeRyWEeBMxexPpNxwD473EyiN6UyI4r9Rg8X0NXjO3WXD8s8o1Bhs53aaoh4uhgs="

install:
  - git clone https://github.com/Opetushallitus/ci-tools.git
  - source ci-tools/common/setup-tools.sh

script:
  - lein ci-test
  - lein uberjar

  - mv target/uberjar/kouta-index-*-standalone.jar $DOCKER_BUILD_DIR/artifact/kouta-index.jar
  - cp -vr oph-configuration $DOCKER_BUILD_DIR/config/

  - export BASE_IMAGE="baseimage-fatjar:master"
  - ./ci-tools/common/pull-image.sh
  - ./ci-tools/build/build-fatjar.sh kouta-index

deploy:
  provider: script
  script: ./ci-tools/build/upload-image.sh kouta-index
  on:
    all_branches: true
